<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="userProfile" style="display: none;">
        <span id="userName"></span>
        <button onclick="toggleProfile()">Toggle Profile</button>
    </div>
    <div id="quizContainer"></div>
    <div id="optionsContainer"></div>
    <div>
        <span id="currentQuestionIndex"></span> / <span id="totalQuestions"></span>
        <button id="nextButton" onclick="nextQuestion()">Next</button>
        <button id="submitButton" onclick="submitQuiz()" style="display: none;">Submit</button>
    </div>
    <div id="result"></div>
    <div id="detailedResults" style="display: none;"></div>
    <div id="chartContainer" style="display: none;">
        <canvas id="scoreChart"></canvas>
    </div>
    <div id="timeLeft"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCotpjWvQ5cG5cOpgiNvpAS4ftvwKRO_N0",
            authDomain: "eduhub-a3762.firebaseapp.com",
            databaseURL: "https://eduhub-a3762-default-rtdb.firebaseio.com",
            projectId: "eduhub-a3762",
            storageBucket: "eduhub-a3762.appspot.com",
            messagingSenderId: "379405101285",
            appId: "1:379405101285:web:b30b3283037317fbe97880"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let results = [];
        let timer;
        const totalTime = 300; // Total time for the quiz
        let user = null;

        auth.onAuthStateChanged(userData => {
            if (userData) {
                user = userData;
                document.getElementById('userName').innerText = `Welcome, ${user.displayName || user.email}!`;
                document.getElementById('userProfile').style.display = 'block';
                loadQuestions();
            } else {
                window.location.href = 'login.html';
            }
        });

        function toggleProfile() {
            const profile = document.getElementById('userProfile');
            profile.style.display = profile.style.display === 'block' ? 'none' : 'block';
        }

        function getExamId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('examId');
        }

        function loadQuestions() {
            const examId = getExamId();
            questions = []; // Clear previous questions
            database.ref(`exams/${examId}/quizzes`).once('value').then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    questions.push(childSnapshot.val());
                });
                document.getElementById('totalQuestions').innerText = questions.length;
                if (questions.length > 0) {
                    startTimer();
                    displayQuestion();
                } else {
                    alert('No questions available for this exam.');
                }
            }).catch(error => {
                console.error('Error loading questions:', error);
            });
        }

        function startTimer() {
            let timeLeft = totalTime;
            document.getElementById('timeLeft').innerText = formatTime(timeLeft);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').innerText = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    alert('Time is up! Submitting your quiz.');
                    submitQuiz();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function displayQuestion() {
            const questionContainer = document.getElementById('quizContainer');
            const optionsContainer = document.getElementById('optionsContainer');
            const questionData = questions[currentQuestionIndex];

            questionContainer.innerHTML = `<h3>${questionData.question}</h3>`;
            optionsContainer.innerHTML = '';
            questionData.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.innerText = option;
                optionDiv.onclick = () => selectOption(index + 1);
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('currentQuestionIndex').innerText = currentQuestionIndex + 1;
            updateProgressBar();
        }

        function selectOption(selectedOption) {
            const optionElements = document.querySelectorAll('.option');
            optionElements.forEach((optionElement, index) => {
                optionElement.classList.remove('selected');
                if (index + 1 === selectedOption) {
                    optionElement.classList.add('selected');
                }
            });
            results[currentQuestionIndex] = {
                question: questions[currentQuestionIndex].question,
                selected: selectedOption,
                correct: questions[currentQuestionIndex].correctOption
            };
        }

        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBarFill').style.width = `${progress}%`;
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                if (currentQuestionIndex === questions.length - 1) {
                    document.getElementById('nextButton').style.display = 'none';
                    document.getElementById('submitButton').style.display = 'block';
                }
            }
        }

        function calculateScore() {
            score = results.reduce((total, result) => {
                if (result.selected == result.correct) return total + 4; 
                if (result.selected) return total - 1; 
                return total; 
            }, 0);
        }

        function submitQuiz() {
            clearInterval(timer);
            calculateScore();
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('optionsContainer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('submitButton').style.display = 'none';

            showResults();
            saveScoreToDatabase();
        }

        function showResults() {
            const totalQuestions = questions.length;
            const correctAnswers = results.filter(result => result.selected == result.correct).length;
            const incorrectAnswers = results.filter(result => result.selected && result.selected != result.correct).length;
            const missedQuestions = totalQuestions - correctAnswers - incorrectAnswers;
            const percentage = ((correctAnswers * 4) / (totalQuestions * 4)) * 100;

            const resultText = `
                Total Questions: ${totalQuestions}<br>
                Correct Answers: ${correctAnswers}<br>
                Incorrect Answers: ${incorrectAnswers}<br>
                Missed Questions: ${missedQuestions}<br>
                Total Score: ${score}<br>
                Percentage: ${percentage.toFixed(2)}%
            `;
            document.getElementById('result').innerHTML = resultText;

            showDetailedResults();
            showChart(correctAnswers, incorrectAnswers, missedQuestions);
            showQuestionList();
        }

        function showDetailedResults() {
            const detailedResultsContainer = document.getElementById('detailedResults');
            detailedResultsContainer.innerHTML = `<h2>Detailed Results</h2><table><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th></tr>`;
            results.forEach(result => {
                const yourAnswer = result.selected ? result.selected : 'Not Answered';
                const correctAnswer = result.correct;
                const rowClass = result.selected === result.correct ? 'correct' : 'incorrect';
                detailedResultsContainer.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${result.question}</td>
                        <td>${yourAnswer}</td>
                        <td>${correctAnswer}</td>
                    </tr>`;
            });
            detailedResultsContainer.innerHTML += `</table>`;
            detailedResultsContainer.style.display = 'block';
        }

        function showQuestionList() {
            const questionListContainer = document.createElement('div');
            questionListContainer.className = 'question-list';
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.innerText = `Q${index + 1}: ${question.question}`;
                questionListContainer.appendChild(questionDiv);
            });
            document.getElementById('result').appendChild(questionListContainer);
        }

        function showChart(correct, incorrect, missed) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Correct', 'Incorrect', 'Missed'],
                    datasets: [{
                        data: [correct, incorrect, missed],
                        backgroundColor: ['green', 'red', 'gray']
                    }]
                }
            });
            document.getElementById('chartContainer').style.display = 'block';
        }

        function saveScoreToDatabase() {
            const userId = user.uid;
            const examId = getExamId();
            database.ref(`scores/${userId}/${examId}`).set({
                score: score,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log('Score saved successfully!');
            }).catch(error => {
                console.error('Error saving score:', error);
            });
        }
    </script>
</body>
</html>
